<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pricing – Wringo.ai</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <nav class="nav">
    <div class="nav-inner">
      <a href="/" class="nav-brand">
        <div class="logo">W</div>
        <span>Wringo.ai</span>
      </a>
      <div class="nav-links">
        <a href="/features.html">Features</a>
        <a href="/pricing.html" class="active">Pricing</a>
        <a href="/demo.html" class="nav-cta">Talk to Jason</a>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="section-inner">
      <h1 class="section-title">Simple, Transparent Pricing</h1>
      <p class="section-subtitle">Choose your plan. Scale as you grow. No hidden fees.</p>

      <!-- Dynamic Pricing Grid -->
      <div id="pricing-container" style="margin-top: 60px;">
        <div style="text-align: center; padding: 60px;">
          <div style="font-size: 48px; margin-bottom: 20px;">⏳</div>
          <p style="color: var(--muted);">Loading pricing from Stripe...</p>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Fetch pricing dynamically from Stripe
    async function loadPricing() {
      try {
        const res = await fetch('https://wringo-backend.onrender.com/api/stripe/pricing');
        const prices = await res.json();

        // Group by type
        const subscriptions = prices.filter(p => p.interval !== 'one_time');
        const oneTime = prices.filter(p => p.interval === 'one_time' && !p.metadata.is_credit_bundle);
        const bundles = prices.filter(p => p.metadata.is_credit_bundle === 'true');

        renderPricing(subscriptions, oneTime, bundles);
      } catch (err) {
        document.getElementById('pricing-container').innerHTML = `
          <div style="text-align: center; padding: 60px; color: #ff6b6b;">
            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
            <p>Failed to load pricing. Please refresh or contact support.</p>
          </div>
        `;
      }
    }

    function renderPricing(subscriptions, oneTime, bundles) {
      const container = document.getElementById('pricing-container');
      
      let html = '<div style="max-width: 1200px; margin: 0 auto;">';

      // Subscriptions
      if (subscriptions.length > 0) {
        html += '<h2 style="text-align: center; margin-bottom: 40px;">Subscription Plans</h2>';
        html += '<div class="yo-grid">';
        subscriptions.forEach(price => {
          const amount = (price.amount / 100).toFixed(2);
          html += `
            <div class="yo-card">
              <div class="yo-content">
                <h3>${price.productName}</h3>
                <div style="font-size: 48px; font-weight: 800; color: var(--brand); margin: 20px 0;">
                  $${amount}
                  <span style="font-size: 18px; color: var(--muted);">/${price.interval}</span>
                </div>
                <p>${price.productDescription || ''}</p>
                <button onclick="checkout('${price.priceId}', 'subscription')" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                  Subscribe Now
                </button>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // One-time actions
      if (oneTime.length > 0) {
        html += '<h2 style="text-align: center; margin: 80px 0 40px;">Pay-Per-Use Actions</h2>';
        html += '<div class="yo-grid">';
        oneTime.forEach(price => {
          const amount = (price.amount / 100).toFixed(2);
          html += `
            <div class="yo-card">
              <div class="yo-content">
                <h3>${price.productName}</h3>
                <div style="font-size: 36px; font-weight: 800; color: var(--speak); margin: 20px 0;">
                  $${amount}
                </div>
                <p>${price.productDescription || 'One-time purchase'}</p>
                <button onclick="checkout('${price.priceId}', 'action', '${price.productName.toLowerCase().replace(/\s+/g, '_')}')" class="btn btn-secondary" style="width: 100%; margin-top: 20px;">
                  Purchase
                </button>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // Credit bundles
      if (bundles.length > 0) {
        html += '<h2 style="text-align: center; margin: 80px 0 40px;">Credit Bundles</h2>';
        html += '<div class="yo-grid">';
        bundles.forEach(price => {
          const amount = (price.amount / 100).toFixed(2);
          const creditAmount = price.metadata.credit_amount || '?';
          html += `
            <div class="yo-card">
              <div class="yo-content">
                <h3>${creditAmount} Credits</h3>
                <div style="font-size: 36px; font-weight: 800; color: var(--brand); margin: 20px 0;">
                  $${amount}
                </div>
                <p>${price.productDescription || 'Prepaid credits'}</p>
                <button onclick="checkout('${price.priceId}', 'credits')" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                  Buy Credits
                </button>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      html += '</div>';
      container.innerHTML = html;
    }

    async function checkout(priceId, purchaseType, entitlementKey = '') {
      // TODO: Get actual user ID from auth session
      const userId = prompt('Enter your user ID (temporary - will use auth):');
      if (!userId) return;

      try {
        const res = await fetch('https://wringo-backend.onrender.com/api/stripe/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            priceId,
            userId,
            purchaseType,
            entitlementKey,
            successUrl: window.location.origin + '/success',
            cancelUrl: window.location.href,
          }),
        });

        const { url } = await res.json();
        window.location.href = url;
      } catch (err) {
        alert('Checkout failed. Please try again.');
      }
    }

    loadPricing();
  </script>
</body>
</html>
